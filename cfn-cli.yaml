Version: 3

# Level 400 sample: cross region, cross account, multiple stages
# Project identifier: "solder400"

Blueprints:

  Tools:
    Profile: <profile-for-tools-account>
    Region: us-east-1
    Tags:
      Environment: Develop

  Test:
    Profile: <profile-for-cross-deploy-account>
    Region: us-east-1
    Tags:
      Environment: Test

Stages:

  CIBase:
    Order: 1

    PipelineRole:
      Extends: Tools
      Order: 1
      StackName: solder400ci-role
      Template: ci-base/pipeline-role.template.yaml
      Capabilities: [CAPABILITY_IAM]

    PreReq2nd:
      Extends: Tools
      Region: us-west-2
      Order: 2
      StackName: solder400ci-prereq
      Template: ci-base/prereq.template.yaml
      Capabilities: [CAPABILITY_IAM]
      Parameters:
        ProjectIdentifier: solder400
        Account1: "<tools-account>"
        Account2: "<tools-account>"
        Account3: "<deploy-account>"
        PrimaryRegion: us-east-1
        CodePipelineServiceRole: ${CIBase.PipelineRole.CodePipelineServiceRole}
        CodeBuildServiceRole: ${CIBase.PipelineRole.CodeBuildServiceRole}

    PreReq:
      Extends: Tools

      Order: 3
      StackName: solder400ci-prereq
      Template: ci-base/prereq.template.yaml
      Capabilities: [CAPABILITY_IAM]
      Parameters:
        ProjectIdentifier: solder400
        Account1: "<tools-account>"
        Account2: "<tools-account>"
        Account3: "<deploy-account>"
        PrimaryRegion: us-east-1
        CodePipelineServiceRole: ${CIBase.PipelineRole.CodePipelineServiceRole}
        CodeBuildServiceRole: ${CIBase.PipelineRole.CodeBuildServiceRole}
        SecondaryRegion: us-west-2
        SecondaryArtifactBucket: ${CIBase.PreReq2nd.ArtifactBucket}
        SecondaryKMSKey: ${CIBase.PreReq2nd.KmsKeyArn}

    TestAccountRole:
      Extends: Test
      Order: 10
      StackName: solder400ci-role
      Template: ci-base/xaccount-role.template.yaml
      Capabilities: [CAPABILITY_NAMED_IAM]
      Parameters:
        ProjectIdentifier: solder400
        ToolsAccount: "<tools-account>"
        ArtifactBuckets: >
          ${CIBase.PreReq.ArtifactBucket},
          ${CIBase.PreReq2nd.ArtifactBucket}
        KmsKeyArns: >
          ${CIBase.PreReq.KmsKeyArn},
          ${CIBase.PreReq2nd.KmsKeyArn}
        AdditonalRegions: 1
        PermissionsBoundary: ""

  Pipelines:
    Order: 10
    Layers:
      Extends: Tools
      StackName: solder400-pipeline-layers
      Template: ci-pipelines/lambda-layer-pipeline.template.yaml
      Capabilities: [CAPABILITY_IAM]
      Parameters:
        PreReqStack: ${CIBase.PreReq.StackName}
        SourcePrefix: source.zip
        PipelineName: Solder400-CrossAccountCrossRegionLambdaLayer
        StageNames: QA,Staging,Prod
        ConfirmStageTransition: "no"
        BlockLastStage: "no"
        UseSecondaryRegion: "yes"
        Account1: "<tools-account>"
        Account2: "<tools-account>"
        Account3: "<deploy-account>"
        StackNames: >
          solder400-layers-qa,
          solder400-layers-staging,
          solder400-layers-prod,
        LayerNames: >
          Solder400CommonPy37-test,
          Solder400CommonPy37-staging,
          Solder400CommonPy37-prod
#
#    TodoApi:
#      Extends: Tools
#      StackName: solder100-pipeline-todoapi
#      Template: ci-pipelines/todoapi-pipeline.template.yaml
#      Capabilities: [CAPABILITY_IAM]
#      Parameters:
#        PreReqStack: ${CIBase.PreReq.StackName}
#        SourcePrefix: source.zip
#        Account1: "<tools-account>"
#        StackNames: solder100-todoapi
#        LambdaLayerNames: Solder100CommonPy37
#        LambdaLayerVersions: 2
