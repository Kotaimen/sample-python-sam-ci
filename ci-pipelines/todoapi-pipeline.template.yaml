AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Build, test and deploy SAM template.

Parameters:

  PreReqStack:
    Description: >
      Name of pre-requests stack, must be in same account&region of the pipeline stack.
    Type: String
    MinLength: 1
    MaxLength: 128
    AllowedPattern: "[a-zA-Z0-9-]+"
    ConstraintDescription: >
      Stack name must start with an alphabetic character and can't be longer
      than 128 characters

  SourceBucket:
    Type: String
    Description: >
      S3 bucket for input source artifact, the pipeline will default to Source bucket in PrePreq stack
      if this is left empty.
    Default: ""

  SourcePrefix:
    Type: String
    Description: >
      S3 prefix of input source artifact in the source bucket.
    MinLength: 1
    MaxLength: 256

  PollS3Change:
    Type: String
    Description: >
      Whether to poll for s3 changes or use CloudTrail S3 events to trigger the Pipeline.
      Trigger is prefered by AWS but each region can only have 5 trails.
    Default: "yes"
    AllowedValues: ["yes", "no"]

  Account1:
    Description: >
      AWS AccountNumber for stage 1.
      Setting this to same account to the pipeline account disables cross account
      deployment automatically.  Setting to empty string disables the stage
      entirely.
    Type: String
    Default: ""
    MinLength: 0
    MaxLength: 12
    AllowedPattern: "[0-9]*"
    ConstraintDescription: Must be numberic string or empty.

  Account2:
    Description: >
      AWS AccountNumber for stage 2.
      Setting this to same account to the pipeline account disables cross account
      deployment automatically.  Setting to empty string disables the stage
      entirely.
    Type: String
    Default: ""
    MinLength: 0
    MaxLength: 12
    AllowedPattern: "[0-9]*"
    ConstraintDescription: Must be numberic string or empty.

  Account3:
    Description: >
      AWS AccountNumber for stage 3.
      Setting this to same account to the pipeline account disables cross account
      deployment automatically.  Setting to empty string disables the stage
      entirely.
    Type: String
    Default: ""
    MinLength: 0
    MaxLength: 12
    AllowedPattern: "[0-9]*"
    ConstraintDescription: Must be numberic string or empty.

  PipelineName:
    Description: >
      Name of the pipeline being created, by default a random name is generated
    Type: String
    Default: ""

  UseSecondaryRegion:
    Description: >
      Deploy to secondary region, note secondary region will only work when the PreReq are setup properly.
    Type: String
    Default: "no"
    AllowedValues: ["yes", "no"]

  StageNames:
    Description: >
      Deployment stage names of the pipeline, separated by ",".
    Type: CommaDelimitedList
    Default: Development,Testing,Production

  ConfirmStageTransition:
    Description: >
      Require manual confirm on stage transitions.
    Type: String
    Default: "no"
    AllowedValues: ["yes", "no"]

  BlockLastStage:
    Description: >
      Block transaction to last (typically set to production) stage,
      this only works when last stage is enabled.
    Type: String
    Default: "no"
    AllowedValues: ["yes", "no"]

  StackUpdateActionMode:
    Description: >
      Stack deployment action mode for non-production stages.
    Type: String
    Default: CREATE_UPDATE
    AllowedValues: [REPLACE_ON_FAILURE, CREATE_UPDATE]

  StackNames:
    Description: >
      Name of the lambda layer stack in each stages, separated by ",", unused stages can be ignored.
      Eg: "Dev", "Dev,Test" or "_,Test,_,Prod".
    Type: CommaDelimitedList
    Default: stack-name

  LambdaLayerNames:
    Description: >
      Name of the lambda layer in each stages, separated by ",", unused stages can be ignored.
      Eg: "Dev", "Dev,Test" or "_,Test,_,Prod".
    Type: CommaDelimitedList
    Default: layer-name

  LambdaLayerVersions:
    Description: >
      Version of the lambda layer in each stages, separated by ",", unused stages can be ignored.
      Eg: "Dev", "Dev,Test" or "_,Test,_,Prod".
    Type: CommaDelimitedList
    Default: "1"

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Project Configuration
        Parameters:
          - PreReqStack
          - SourceBucket
          - SourcePrefix
      - Label:
          default: Account Configuration
        Parameters:
          - Account1
          - Account2
          - Account3
      - Label:
          default: Pipeline Behaviour
        Parameters:
          - PipelineName
          - StageNames
          - UseSecondaryRegion
          - ConfirmStageTransition
          - BlockLastStage
          - StackUpdateActionMode
          - PollS3Change
      - Label:
          default: Stack Configuration
        Parameters:
          - StackNames
          - LambdaLayerNames
          - LambdaLayerVersions
    ParameterLabels:
      PreReqStack:
        default: PreRequests Stack
      SourceBucket:
        default: Source Bucket
      SourcePrefix:
        default: Source Prefix
      Account1:
        default: Account 1
      Account2:
        default: Account 2
      Account3:
        default: Account 3
      PipelineName:
        default: Pipeline Name
      StageNames:
        default: Stage Names
      UseSecondaryRegion:
        default: Use Secondary Region
      ConfirmStageTransition:
        default: Confirm Stage Transition
      StackUpdateActionMode:
        default: Stack Update Action Mode
      BlockLastStage:
        default: Block Last Stage
      PollS3Change:
        default: Poll S3 Change
      LambdaLayerNames:
        default: Lambda Layer Names
      LambdaLayerVersions:
        default: Lambda Layer Versions


Conditions:
  #  Detect "same account" situation
  CrossAccount1Condition: !Not [!Equals [!Ref Account1, !Ref "AWS::AccountId"]]
  CrossAccount2Condition: !Not [!Equals [!Ref Account2, !Ref "AWS::AccountId"]]
  CrossAccount3Condition: !Not [!Equals [!Ref Account3, !Ref "AWS::AccountId"]]

  # Stages to enable
  EnableStage1Condition: !Not [!Equals [!Ref Account1, ""]]
  EnableStage2Condition: !Not [!Equals [!Ref Account2, ""]]
  EnableStage3Condition: !Not [!Equals [!Ref Account3, ""]]

  # Misc
  DisableS3PollCondition: !Not [!Equals [!Ref PollS3Change, "yes"]]
  NamedPipelineCondition: !Not [!Equals [!Ref PipelineName, ""]]
  UseDefaultSourceBucketCondition: !Equals [!Ref SourceBucket, ""]
  ConfirmStageTransitionCondition: !Equals [!Ref ConfirmStageTransition, "yes"]
  BlockLastStageCondition: !And [!Condition EnableStage3Condition, !Equals [!Ref BlockLastStage, "yes"]]
  UseSecondaryRegionCondition: !Equals [!Ref UseSecondaryRegion, "yes"]

Mappings:

  StackConfig:
    Develop:
      Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
      TemplatePath: services/todoapi/.aws-sam/build/packaged.yaml
      TemplateConfiguration: services/todoapi/stack-config-dev.json
    Test:
      Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
      TemplatePath: services/todoapi/.aws-sam/build/packaged.yaml
      TemplateConfiguration: services/todoapi/stack-config-test.json
#    Staging:
#      Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
#      TemplatePath: services/todoapi/.aws-sam/build/packaged.yaml
#      TemplateConfiguration: services/todoapi/stack-config-staging.json
    Production:
      Capabilities: CAPABILITY_IAM
      TemplatePath: services/todoapi/.aws-sam/build/packaged.yaml
      TemplateConfiguration: services/todoapi/stack-config-prod.json

Resources:

  TestProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Run unittests
      ServiceRole: { "Fn::ImportValue": !Sub "${PreReqStack}:CodeBuildServiceRoleArn" }
      TimeoutInMinutes: 30
      EncryptionKey: { "Fn::ImportValue": !Sub "${PreReqStack}:KmsKeyArn" }
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:2.0
        PrivilegedMode: true
      Cache:
        Type: S3
        Modes:
          - LOCAL_CUSTOM_CACHE
          - LOCAL_DOCKER_CSAC
        Location: !Join ["/", [{ "Fn::ImportValue": !Sub "${PreReqStack}:ArtifactBucket" }, "codebuild-cache"]]
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          env:
            variables:
              SAM_CLI_TELEMETRY: 0
          phases:
            install:
              runtime-versions:
                python: 3.7
                docker: 18
              commands:
                - echo Entered the install phase...
                - nohup /usr/local/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2375 --storage-driver=overlay&
                - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
                - docker pull amazon/dynamodb-local
                - pip3 install -r requirements-dev.txt -r requirements.txt
              finally:
                - echo Leaving install phase...
            pre_build:
              commands:
                - echo Entered the pre_build phase...
                - docker run -d -p 8000:8000 amazon/dynamodb-local
                - cd ${WORKDIR}
              finally:
                - echo Leaving pre_build phrase..
            build:
              commands:
                - echo Entered the build phase...
                - make ${MAKE_TAREGET}
              finally:
                - echo Leaving build phase...
            post_build:
              commands:
                - echo Entered the post_build phase...
              finally:
                - echo Leaving post_build phase...
          cache:
            paths:
              - '/root/.cache/pip/**/*'

  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Description: Build and package SAM projects
      ServiceRole: { "Fn::ImportValue": !Sub "${PreReqStack}:CodeBuildServiceRoleArn" }
      TimeoutInMinutes: 30
      EncryptionKey: { "Fn::ImportValue": !Sub "${PreReqStack}:KmsKeyArn" }
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:2.0
        PrivilegedMode: true
      Cache:
        Type: S3
        Modes:
          - LOCAL_CUSTOM_CACHE
        Location: !Join ["/", [{ "Fn::ImportValue": !Sub "${PreReqStack}:ArtifactBucket" }, "codebuild-cache"]]
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.7
              commands:
                - echo Entered the install phase...
                - pip3 install -r requirements-dev.txt
              finally:
                - echo Leaving install phase...
            pre_build:
              commands:
                - echo Entered the pre_build phase...
                - cd ${WORKDIR}
              finally:
                - echo Leaving pre_build phrase..
            build:
              commands:
                - echo Entered the build phase...
                - make package
              finally:
                - echo Leaving build phase...
            post_build:
              commands:
                - echo Entered the post_build phase...
              finally:
                - echo Leaving post_build phase...
          cache:
            paths:
              - '/root/.cache/pip/**/*'
          artifacts:
            files: '**/*'
            discard-paths: no

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name:
        Fn::If:
          - NamedPipelineCondition
          - !Ref PipelineName
          - !Ref AWS::NoValue
      RoleArn: { "Fn::ImportValue": !Sub "${PreReqStack}:CodePipelineServiceRoleArn" }
      ArtifactStores:
        - Region: { "Fn::ImportValue": !Sub "${PreReqStack}:PrimaryRegion" }
          ArtifactStore:
            Type: S3
            Location: { "Fn::ImportValue": !Sub "${PreReqStack}:ArtifactBucket" }
            EncryptionKey:
              Type: KMS
              Id: { "Fn::ImportValue": !Sub "${PreReqStack}:KmsKeyArn" }
        - Fn::If:
          - UseSecondaryRegionCondition
          - Region: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
            ArtifactStore:
              Type: S3
              Location: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryArtifactBucket" }
              EncryptionKey:
                Type: KMS
                Id: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryKmsKeyArn" }
          - !Ref AWS::NoValue
      RestartExecutionOnUpdate: false
      DisableInboundStageTransitions:
        Fn::If:
          - BlockLastStageCondition
          - - StageName: !Sub [ "DeployTo${STAGE_NAME}", { STAGE_NAME: !Select [ 2, !Ref StageNames ] } ]
              Reason: "Disabled transition"
          - !Ref AWS::NoValue
      Stages:

        - Name: Source
          Actions:
            - Name: S3Source
              RunOrder: 1
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: "1"
                Provider: S3
              Configuration:
                S3Bucket: !If
                  - UseDefaultSourceBucketCondition
                  - { "Fn::ImportValue": !Sub "${PreReqStack}:SourceBucket" }
                  - !Ref SourceBucket
                S3ObjectKey: !Ref SourcePrefix
                PollForSourceChanges: !If
                  - DisableS3PollCondition
                  - false
                  - true
              OutputArtifacts:
                - Name: SourceArtifact

        - Name: Test
          Actions:
            - Name: Test
              RunOrder: 1
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TestProject
                PrimarySource: SourceArtifact
                EnvironmentVariables: >
                  [
                    {"name": "WORKDIR", "value": ".", "type": "PLAINTEXT"},
                    {"name": "MAKE_TAREGET", "value": "test", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: SourceArtifact
            - Name: Coverage
              RunOrder: 1
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TestProject
                PrimarySource: SourceArtifact
                EnvironmentVariables: >
                  [
                    {"name": "WORKDIR", "value": ".", "type": "PLAINTEXT"},
                    {"name": "MAKE_TAREGET", "value": "coverage", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: SourceArtifact
            - Name: Lint
              RunOrder: 1
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref TestProject
                PrimarySource: SourceArtifact
                EnvironmentVariables: >
                  [
                    {"name": "WORKDIR", "value": ".", "type": "PLAINTEXT"},
                    {"name": "MAKE_TAREGET", "value": "lint", "type": "PLAINTEXT"}
                  ]
              InputArtifacts:
                - Name: SourceArtifact

        - Name: Build
          Actions:
            - Name: CfnBuild
              RunOrder: 1
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: "1"
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref BuildProject
                PrimarySource: SourceArtifact
                EnvironmentVariables:
                  Fn::Sub:
                    - >
                      [
                        {"name": "WORKDIR", "value": ".", "type": "PLAINTEXT"},
                        {"name": "MAKE_TAREGET", "value": "build", "type": "PLAINTEXT"},
                        {"name": "TEMPLATE_BUCKET", "value": "${TEMPLATE_BUCKET}", "type": "PLAINTEXT"},
                        {"name": "TEMPLATE_PREFIX", "value": "codebuild-packaged-templates", "type": "PLAINTEXT"},
                        {"name": "KMS_KEY_ARN", "value": "${KMS_KEY_ARN}", "type": "PLAINTEXT"}

                      ]
                    - TEMPLATE_BUCKET: { "Fn::ImportValue": !Sub "${PreReqStack}:ArtifactBucket" }
                      KMS_KEY_ARN: { "Fn::ImportValue": !Sub "${PreReqStack}:KmsKeyArn" }
              InputArtifacts:
                - Name: SourceArtifact
              OutputArtifacts:
                - Name: PackagedArtifact
            - Fn::If:
              - UseSecondaryRegionCondition
              - Name: CfnBuild2ndRegion
                RunOrder: 1
                ActionTypeId:
                  Category: Build
                  Owner: AWS
                  Version: "1"
                  Provider: CodeBuild
                Configuration:
                  ProjectName: !Ref BuildProject
                  PrimarySource: SourceArtifact
                  EnvironmentVariables:
                    Fn::Sub:
                      - >
                        [
                          {"name": "WORKDIR", "value": ".", "type": "PLAINTEXT"},
                          {"name": "MAKE_TAREGET", "value": "build", "type": "PLAINTEXT"},
                          {"name": "TEMPLATE_BUCKET", "value": "${TEMPLATE_BUCKET}", "type": "PLAINTEXT"},
                          {"name": "TEMPLATE_PREFIX", "value": "codebuild-packaged-templates", "type": "PLAINTEXT"},
                          {"name": "KMS_KEY_ARN", "value": "${KMS_KEY_ARN}", "type": "PLAINTEXT"}
                        ]
                      - TEMPLATE_BUCKET: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryArtifactBucket" }
                        KMS_KEY_ARN: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryKmsKeyArn" }
                InputArtifacts:
                  - Name: SourceArtifact
                OutputArtifacts:
                  - Name: PackagedArtifact2nd
              - !Ref AWS::NoValue

        - Fn::If:
          - EnableStage1Condition
          - Name: !Sub [ "DeployTo${STAGE_NAME}", { STAGE_NAME: !Select [ 0, !Ref StageNames ] } ]
            Actions:
              - Name: Deploy
                RunOrder: 1
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Version: "1"
                  Provider: CloudFormation
                RoleArn: !If
                  - CrossAccount1Condition
                  - !Sub
                    - arn:aws:iam::${Account1}:role/${ProjectName}-CrossAccountRole
                    - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                  - !Ref AWS::NoValue
                InputArtifacts:
                  - Name: PackagedArtifact
                OutputArtifacts:
                  - Name: TodoApiDevStackOutput
                Configuration:
                  ActionMode: !Ref StackUpdateActionMode
                  RoleArn: !If
                    - CrossAccount1Condition
                    - !Sub
                      - arn:aws:iam::${Account1}:role/${ProjectName}-CloudFormationDeployRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                  Capabilities: !FindInMap [StackConfig, Develop, Capabilities]
                  StackName: !Select [0, !Ref StackNames]
                  TemplatePath: !Join [ "::", ["PackagedArtifact", !FindInMap [StackConfig, Develop, TemplatePath]] ]
                  TemplateConfiguration: !Join [ "::", ["PackagedArtifact", !FindInMap [StackConfig, Develop, TemplateConfiguration]] ]
                  ParameterOverrides: !Sub
                    - >
                      {
                        "CommonLayerArn": "arn:aws:lambda:${REGION}:${Account1}:layer:${NAME}:${VERSION}",
                        "LogLevel": "DEBUG"
                      }
                    - NAME: !Select [0, !Ref LambdaLayerNames]
                      VERSION: !Select [0, !Ref LambdaLayerVersions]
                      REGION: !Ref AWS::Region
                  OutputFileName: stack-output.json
              - Fn::If:
                - UseSecondaryRegionCondition
                - Name: Deploy2ndRegion
                  RunOrder: 1
                  Region: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                  ActionTypeId:
                    Category: Deploy
                    Owner: AWS
                    Version: "1"
                    Provider: CloudFormation
                  RoleArn: !If
                    - CrossAccount1Condition
                    - !Sub
                      - arn:aws:iam::${Account1}:role/${ProjectName}-CrossAccountRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - !Ref AWS::NoValue
                  InputArtifacts:
                    - Name: PackagedArtifact2nd
                  OutputArtifacts:
                    - Name: TodoApiDevStackOutput2nd
                  Configuration:
                    ActionMode: !Ref StackUpdateActionMode
                    RoleArn: !If
                      - CrossAccount1Condition
                      - !Sub
                        - arn:aws:iam::${Account1}:role/${ProjectName}-CloudFormationDeployRole
                        - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                      - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                    Capabilities: !FindInMap [StackConfig, Develop, Capabilities]
                    StackName: !Select [0, !Ref StackNames]
                    TemplatePath: !Join [ "::", ["PackagedArtifact2nd", !FindInMap [StackConfig, Develop, TemplatePath]] ]
                    TemplateConfiguration: !Join [ "::", ["PackagedArtifact2nd", !FindInMap [StackConfig, Develop, TemplateConfiguration]] ]
                    ParameterOverrides: !Sub
                      - >
                        {
                          "CommonLayerArn": "arn:aws:lambda:${REGION}:${Account1}:layer:${NAME}:${VERSION}",
                          "LogLevel": "DEBUG"
                        }
                      - NAME: !Select [0, !Ref LambdaLayerNames]
                        VERSION: !Select [0, !Ref LambdaLayerVersions]
                        REGION: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                    OutputFileName: stack-output.json
                - !Ref AWS::NoValue
              - Fn::If:
                - ConfirmStageTransitionCondition
                - Name: Review
                  RunOrder: 2
                  ActionTypeId:
                    Category: Approval
                    Owner: AWS
                    Version: "1"
                    Provider: Manual
                  Configuration:
                    NotificationArn: { "Fn::ImportValue": { "Fn::Sub": "${PreReqStack}:NotificationTopicArn" } }
                    CustomData: !Sub [ "Review ${STAGE_NAME}", { STAGE_NAME: !Select [ 0, !Ref StageNames ] } ]
                - !Ref AWS::NoValue
          - !Ref AWS::NoValue

        - Fn::If:
          - EnableStage2Condition
          - Name: !Sub [ "DeployTo${STAGE_NAME}", { STAGE_NAME: !Select [ 1, !Ref StageNames ] } ]
            Actions:
              - Name: Deploy
                RunOrder: 1
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Version: "1"
                  Provider: CloudFormation
                RoleArn: !If
                  - CrossAccount2Condition
                  - !Sub
                    - arn:aws:iam::${Account2}:role/${ProjectName}-CrossAccountRole
                    - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                  - !Ref AWS::NoValue
                InputArtifacts:
                  - Name: PackagedArtifact
                OutputArtifacts:
                  - Name: TodoApiTestStackOutput
                Configuration:
                  ActionMode: !Ref StackUpdateActionMode
                  RoleArn: !If
                    - CrossAccount2Condition
                    - !Sub
                      - arn:aws:iam::${Account2}:role/${ProjectName}-CloudFormationDeployRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                  Capabilities: !FindInMap [StackConfig, Test, Capabilities]
                  StackName: !Select [1, !Ref StackNames]
                  TemplatePath: !Join [ "::", ["PackagedArtifact", !FindInMap [StackConfig, Test, TemplatePath]] ]
                  TemplateConfiguration: !Join [ "::", ["PackagedArtifact", !FindInMap [StackConfig, Test, TemplateConfiguration]] ]
                  ParameterOverrides: !Sub
                    - >
                      {
                        "CommonLayerArn": "arn:aws:lambda:${REGION}:${Account2}:layer:${NAME}:${VERSION}",
                        "LogLevel": "DEBUG"
                      }
                    - NAME: !Select [1, !Ref LambdaLayerNames]
                      VERSION: !Select [1, !Ref LambdaLayerVersions]
                      REGION: !Ref AWS::Region
                  OutputFileName: stack-output.json
              - Fn::If:
                - UseSecondaryRegionCondition
                - Name: Deploy2ndRegion
                  RunOrder: 1
                  Region: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                  ActionTypeId:
                    Category: Deploy
                    Owner: AWS
                    Version: "1"
                    Provider: CloudFormation
                  RoleArn: !If
                    - CrossAccount2Condition
                    - !Sub
                      - arn:aws:iam::${Account2}:role/${ProjectName}-CrossAccountRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - !Ref AWS::NoValue
                  InputArtifacts:
                    - Name: PackagedArtifact2nd
                  OutputArtifacts:
                    - Name: TodoApiTestStackOutput2nd
                  Configuration:
                    ActionMode: !Ref StackUpdateActionMode
                    RoleArn: !If
                      - CrossAccount2Condition
                      - !Sub
                        - arn:aws:iam::${Account2}:role/${ProjectName}-CloudFormationDeployRole
                        - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                      - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                    Capabilities: !FindInMap [StackConfig, Test, Capabilities]
                    StackName: !Select [1, !Ref StackNames]
                    TemplatePath: !Join [ "::", ["PackagedArtifact2nd", !FindInMap [StackConfig, Test, TemplatePath]] ]
                    TemplateConfiguration: !Join [ "::", ["PackagedArtifact2nd", !FindInMap [StackConfig, Test, TemplateConfiguration]] ]
                    ParameterOverrides: !Sub
                      - >
                        {
                          "CommonLayerArn": "arn:aws:lambda:${REGION}:${Account2}:layer:${NAME}:${VERSION}",
                          "LogLevel": "DEBUG"
                        }
                      - NAME: !Select [1, !Ref LambdaLayerNames]
                        VERSION: !Select [1, !Ref LambdaLayerVersions]
                        REGION: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                    OutputFileName: stack-output.json
                - !Ref AWS::NoValue
              - Fn::If:
                - ConfirmStageTransitionCondition
                - Name: Review
                  RunOrder: 2
                  ActionTypeId:
                    Category: Approval
                    Owner: AWS
                    Version: "1"
                    Provider: Manual
                  Configuration:
                    NotificationArn: { "Fn::ImportValue": { "Fn::Sub": "${PreReqStack}:NotificationTopicArn" } }
                    CustomData: !Sub [ "Review ${STAGE_NAME}", { STAGE_NAME: !Select [ 0, !Ref StageNames ] } ]
                - !Ref AWS::NoValue
          - !Ref AWS::NoValue

        - Fn::If:
          - EnableStage3Condition
          - Name: !Sub [ "DeployTo${STAGE_NAME}", { STAGE_NAME: !Select [ 2, !Ref StageNames ] } ]
            Actions:
              - Name: CreateChangeSet
                RunOrder: 1
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Version: "1"
                  Provider: CloudFormation
                RoleArn: !If
                  - CrossAccount3Condition
                  - !Sub
                    - arn:aws:iam::${Account3}:role/${ProjectName}-CrossAccountRole
                    - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                  - !Ref AWS::NoValue
                InputArtifacts:
                  - Name: PackagedArtifact
                Configuration:
                  ChangeSetName: !Sub ${AWS::StackName}-todoapi
                  ActionMode: CHANGE_SET_REPLACE
                  RoleArn: !If
                    - CrossAccount3Condition
                    - !Sub
                      - arn:aws:iam::${Account3}:role/${ProjectName}-CloudFormationDeployRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                  Capabilities: !FindInMap [StackConfig, Production, Capabilities]
                  StackName: !Select [2, !Ref StackNames]
                  TemplatePath: !Join [ "::", ["PackagedArtifact", !FindInMap [StackConfig, Production, TemplatePath]] ]
                  TemplateConfiguration: !Join [ "::", ["PackagedArtifact", !FindInMap [StackConfig, Production, TemplateConfiguration]] ]
                  ParameterOverrides: !Sub
                    - >
                      {
                        "CommonLayerArn": "arn:aws:lambda:${REGION}:${Account3}:layer:${NAME}:${VERSION}",
                        "LogLevel": "INFO"
                      }
                    - NAME: !Select [2, !Ref LambdaLayerNames]
                      VERSION: !Select [2, !Ref LambdaLayerVersions]
                      REGION: !Ref AWS::Region
                  OutputFileName: stack-output.json
              - Fn::If:
                - UseSecondaryRegionCondition
                - Name: CreateChangeSet2nd
                  RunOrder: 1
                  Region: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                  ActionTypeId:
                    Category: Deploy
                    Owner: AWS
                    Version: "1"
                    Provider: CloudFormation
                  RoleArn: !If
                    - CrossAccount3Condition
                    - !Sub
                      - arn:aws:iam::${Account3}:role/${ProjectName}-CrossAccountRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - !Ref AWS::NoValue
                  InputArtifacts:
                    - Name: PackagedArtifact2nd
                  Configuration:
                    ChangeSetName: !Sub ${AWS::StackName}-todoapi
                    ActionMode: CHANGE_SET_REPLACE
                    RoleArn: !If
                      - CrossAccount3Condition
                      - !Sub
                        - arn:aws:iam::${Account3}:role/${ProjectName}-CloudFormationDeployRole
                        - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                      - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                    Capabilities: !FindInMap [StackConfig, Production, Capabilities]
                    StackName: !Select [2, !Ref StackNames]
                    TemplatePath: !Join [ "::", ["PackagedArtifact2nd", !FindInMap [StackConfig, Production, TemplatePath]] ]
                    TemplateConfiguration: !Join [ "::", ["PackagedArtifact2nd", !FindInMap [StackConfig, Production, TemplateConfiguration]] ]
                    ParameterOverrides: !Sub
                      - >
                        {
                          "CommonLayerArn": "arn:aws:lambda:${REGION}:${Account3}:layer:${NAME}:${VERSION}",
                          "LogLevel": "INFO"
                        }
                      - NAME: !Select [2, !Ref LambdaLayerNames]
                        VERSION: !Select [2, !Ref LambdaLayerVersions]
                        REGION: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                    OutputFileName: stack-output.json
                - !Ref AWS::NoValue

              - Name: ReviewChangeSet
                RunOrder: 2
                ActionTypeId:
                  Category: Approval
                  Owner: AWS
                  Version: "1"
                  Provider: Manual
                Configuration:
                  NotificationArn: { "Fn::ImportValue": { "Fn::Sub": "${PreReqStack}:NotificationTopicArn" } }
                  CustomData: Review ChangeSet

              - Name: ExecuteChangeSet
                RunOrder: 3
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Version: "1"
                  Provider: CloudFormation
                RoleArn: !If
                  - CrossAccount3Condition
                  - !Sub
                    - arn:aws:iam::${Account3}:role/${ProjectName}-CrossAccountRole
                    - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                  - !Ref AWS::NoValue
                OutputArtifacts:
                  - Name: TodoApiProductionStackOutput
                Configuration:
                  ChangeSetName: !Sub ${AWS::StackName}-todoapi
                  ActionMode: CHANGE_SET_EXECUTE
                  RoleArn: !If
                    - CrossAccount3Condition
                    - !Sub
                      - arn:aws:iam::${Account3}:role/${ProjectName}-CloudFormationDeployRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                  StackName: !Select [2, !Ref StackNames]
                  OutputFileName: stack-output.json
              - Fn::If:
                - UseSecondaryRegionCondition
                - Name: ExecuteChangeSet2nd
                  RunOrder: 3
                  Region: { "Fn::ImportValue": !Sub "${PreReqStack}:SecondaryRegion" }
                  ActionTypeId:
                    Category: Deploy
                    Owner: AWS
                    Version: "1"
                    Provider: CloudFormation
                  RoleArn: !If
                    - CrossAccount3Condition
                    - !Sub
                      - arn:aws:iam::${Account3}:role/${ProjectName}-CrossAccountRole
                      - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                    - !Ref AWS::NoValue
                  OutputArtifacts:
                    - Name: TodoApiProductionStackOutput2nd
                  Configuration:
                    ChangeSetName: !Sub ${AWS::StackName}-todoapi
                    ActionMode: CHANGE_SET_EXECUTE
                    RoleArn: !If
                      - CrossAccount3Condition
                      - !Sub
                        - arn:aws:iam::${Account3}:role/${ProjectName}-CloudFormationDeployRole
                        - ProjectName: { "Fn::ImportValue": !Sub "${PreReqStack}:ProjectIdentifier" }
                      - { "Fn::ImportValue": !Sub "${PreReqStack}:CloudFormationDeployRoleArn" }
                    StackName: !Select [2, !Ref StackNames]
                    OutputFileName: stack-output.json
                - !Ref AWS::NoValue
          - !Ref AWS::NoValue

  #
  # S3 Pipeline Trigger
  #
  S3CloudTrail:
    Type: AWS::CloudTrail::Trail
    Condition: DisableS3PollCondition
    Properties:
      IsLogging: true
      S3BucketName: { "Fn::ImportValue": !Sub "${PreReqStack}:CloudTrailBucket" }
      EventSelectors:
        - ReadWriteType: WriteOnly
          IncludeManagementEvents: false
          DataResources:
            - Type: AWS::S3::Object
              Values:
                - !Sub
                  - "arn:aws:s3:::${BUCKET_NAME}/${PREFIX}"
                  - BUCKET_NAME: !If
                      - UseDefaultSourceBucketCondition
                      - { "Fn::ImportValue": !Sub "${PreReqStack}:SourceBucket" }
                      - !Ref SourceBucket
                    PREFIX: !Ref SourcePrefix

  S3ObjectCreatedEventsRule:
    Type: AWS::Events::Rule
    Condition: DisableS3PollCondition
    Properties:
      Description: "S3.PutObject for CodePipeline source file"
      State: ENABLED
      EventPattern:
        source:
          - aws.s3
        detail:
          eventSource:
            - s3.amazonaws.com
          eventName:
            - PutObject
          requestParameters:
            bucketName:
              - !If
                - UseDefaultSourceBucketCondition
                - { "Fn::ImportValue": !Sub "${PreReqStack}:SourceBucket" }
                - !Ref SourceBucket
            key:
              - !Ref SourcePrefix
      Targets:
        -
          Id: "TargetCodePipeline"
          Arn: !Sub "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:${Pipeline}"
          RoleArn: !GetAtt EventsCallPipelineRole.Arn

  EventsCallPipelineRole:
    Type: AWS::IAM::Role
    Condition: DisableS3PollCondition
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service: events.amazonaws.com
        Version: "2012-10-17"
      Path: /
      Policies:
        - PolicyName: CodePipelineExecution
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codepipeline:StartPipelineExecution
                Resource: !Sub "arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:${Pipeline}"

Outputs:

  Pipeline:
    Description: CodePipeline Name
    Value: !Ref Pipeline

